<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BW Liu的小世界</title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
        #modeIndicator {
            position: fixed;
            top: 20px;
            left: 20px;
            color: white;
            font-family: Arial;
            font-size: 16px;
            text-shadow: 1px 1px 2px black;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="modeIndicator">当前视角：自由视角 (按T切换)</div>

    <!-- 引入 Three.js 库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/SSAOPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>

    <script>
        let scene, camera, renderer, composer, controls;
        let car, wheelFL, wheelFR, wheelRL, wheelRR;
        const keys = {};

        init();
        animate();

        function init() {
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            
            // Advanced renderer
            renderer = new THREE.WebGLRenderer({
                antialias: true,
                powerPreference: "high-performance"
            });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);

            // PBR Camera setup
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(8, 4, 12);

            // Post-processing
            composer = new THREE.EffectComposer(renderer);
            composer.addPass(new THREE.RenderPass(scene, camera));
            
            const ssaoPass = new THREE.SSAOPass(scene, camera);
            ssaoPass.kernelRadius = 0.6;
            ssaoPass.minDistance = 0.0001;
            ssaoPass.maxDistance = 0.03;
            composer.addPass(ssaoPass);

            // HDRI Environment
            const pmremGenerator = new THREE.PMREMGenerator(renderer);
            pmremGenerator.compileEquirectangularShader();
            
            new THREE.TextureLoader().load(
                'https://threejs.org/examples/textures/equirectangular/venice_sunset_1k.hdr',
                texture => {
                    const envMap = pmremGenerator.fromEquirectangular(texture).texture;
                    scene.environment = envMap;
                    texture.dispose();
                }
            );

            // Terrain with multiple materials
            const terrainGeometry = new THREE.PlaneGeometry(200, 200, 100, 100);
            const materials = [
                new THREE.MeshStandardMaterial({ // Grass
                    color: 0x88ff88,
                    roughness: 0.9,
                    metalness: 0
                }),
                new THREE.MeshStandardMaterial({ // Dirt
                    color: 0x886633,
                    roughness: 0.8,
                    metalness: 0
                })
            ];
            
            const terrain = new THREE.Mesh(terrainGeometry, materials);
            terrain.rotation.x = -Math.PI/2;
            terrain.receiveShadow = true;
            scene.add(terrain);

            // Load sports car
            new THREE.GLTFLoader().load(
                'https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/models/gltf/ferrari.glb',
                gltf => {
                    car = gltf.scene;
                    car.traverse(child => {
                        if (child.isMesh) {
                            child.material.envMapIntensity = 1.5;
                            child.castShadow = true;
                            if(child.name.includes('Wheel')) {
                                child.material.roughness = 0.3;
                                child.material.metalness = 0.9;
                            }
                        }
                    });
                    
                    wheelFL = car.getObjectByName('Wheel_FL');
                    wheelFR = car.getObjectByName('Wheel_FR');
                    wheelRL = car.getObjectByName('Wheel_RL');
                    wheelRR = car.getObjectByName('Wheel_RR');
                    
                    car.scale.set(0.8, 0.8, 0.8);
                    car.position.set(0, 0.5, 0);
                    scene.add(car);
                }
            );

            // Street lights
            const lightGeometry = new THREE.CylinderGeometry(0.1, 0.1, 8);
            const lightMaterial = new THREE.MeshStandardMaterial({
                color: 0x555555,
                metalness: 0.8,
                roughness: 0.2
            });
            
            for(let i = -80; i <= 80; i += 40) {
                const lightPole = new THREE.Mesh(lightGeometry, lightMaterial);
                lightPole.castShadow = true;
                lightPole.position.set(i, 4, 0);
                scene.add(lightPole);
                
                const spotLight = new THREE.SpotLight(0xffee88, 15, 30, Math.PI/6, 0.2);
                spotLight.position.set(i, 6, 0);
                spotLight.castShadow = true;
                spotLight.shadow.mapSize.width = 2048;
                spotLight.shadow.mapSize.height = 2048;
                scene.add(spotLight);
            }

            // Camera controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 1.5, 0);
            controls.minDistance = 5;
            controls.maxDistance = 50;
            controls.enableDamping = true;

            // Input handling
            window.addEventListener('keydown', e => keys[e.code] = true);
            window.addEventListener('keyup', e => keys[e.code] = false);
        }

        function animate() {
            requestAnimationFrame(animate);
            
            // Car controls
            if(car) {
                const speed = 0.15;
                const steering = 0.03;
                const wheelRotation = 0.05;
                
                if(keys['ArrowUp']) {
                    car.position.z -= Math.cos(car.rotation.y) * speed;
                    car.position.x -= Math.sin(car.rotation.y) * speed;
                    
                    if(wheelFL) wheelFL.rotation.z += wheelRotation;
                    if(wheelFR) wheelFR.rotation.z += wheelRotation;
                }
                
                if(keys['ArrowLeft']) {
                    car.rotation.y += steering;
                    if(wheelFL) wheelFL.rotation.x = Math.PI/6;
                    if(wheelFR) wheelFR.rotation.x = Math.PI/6;
                }
                
                // Update camera position
                camera.position.copy(car.position)
                    .add(new THREE.Vector3(
                        -8 * Math.sin(car.rotation.y),
                        4,
                        -8 * Math.cos(car.rotation.y)
                    ));
                controls.target.copy(car.position);
            }

            controls.update();
            composer.render();
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
