<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>全功能创作中心 - bwliubase</title>
    <!-- 核心依赖 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
    <style>
        /* 基础样式...（保留原有基础样式） */

        /* 增强工具栏 */
        .toolbar-group {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 5px 0;
            border-right: 1px solid var(--border-color);
            padding-right: 15px;
        }

        /* 代码语言选择器 */
        .lang-selector {
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            margin-left: 10px;
        }

        /* 表格编辑器 */
        .table-config {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 10px 0;
        }

        /* 表情面板增强 */
        .emoji-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }

        .emoji-tab {
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
        }

        .emoji-tab.active {
            background: var(--primary-color);
            color: white;
        }

        /* 公式工具栏 */
        .formula-toolbar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }

        /* 历史版本面板 */
        .history-panel {
            position: fixed;
            right: 20px;
            top: 100px;
            width: 300px;
            background: white;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <!-- 编辑器左侧 -->
        <div class="editor-pane">
            <div class="editor-toolbar">
                <!-- 功能分组 -->
                <div class="toolbar-group">
                    <button onclick="formatText('bold')"><strong>B</strong></button>
                    <button onclick="formatText('italic')"><em>I</em></button>
                    <button onclick="showEmojiPicker(event)">😀</button>
                    <select class="lang-selector" onchange="insertCodeBlock(this.value)">
                        <option value="">代码语言</option>
                        <option value="javascript">JavaScript</option>
                        <option value="python">Python</option>
                        <option value="java">Java</option>
                        <option value="mermaid">Mermaid</option>
                    </select>
                </div>
                
                <div class="toolbar-group">
                    <button onclick="showTableDialog()">表格</button>
                    <button onclick="insertFormula('block')">公式块</button>
                    <button onclick="insertFormula('inline')">行内公式</button>
                    <input type="file" id="imageUpload" hidden multiple>
                </div>
            </div>
            <textarea id="editor"></textarea>
        </div>

        <!-- 预览区域 -->
        <div class="preview-pane" id="preview"></div>

        <!-- 表情选择器 -->
        <div id="emojiPicker" class="emoji-picker">
            <div class="emoji-tabs">
                <div class="emoji-tab active" onclick="switchEmojiTab('smileys')">表情</div>
                <div class="emoji-tab" onclick="switchEmojiTab('symbols')">符号</div>
            </div>
            <div class="emoji-category" id="smileys">
                <!-- 动态加载表情 -->
            </div>
            <div class="emoji-category" id="symbols" style="display:none;">
                <!-- 特殊符号 -->
            </div>
        </div>

        <!-- 表格配置对话框 -->
        <div class="table-dialog" id="tableDialog">
            <h3>创建表格</h3>
            <div class="table-config">
                <label>行数 <input type="number" id="rows" min="1" value="3"></label>
                <label>列数 <input type="number" id="cols" min="1" value="3"></label>
                <label>表头 <input type="checkbox" id="hasHeader" checked></label>
                <select id="alignment">
                    <option value="left">左对齐</option>
                    <option value="center">居中</option>
                    <option value="right">右对齐</option>
                </select>
            </div>
            <button onclick="generateTable()">生成</button>
            <button onclick="closeDialog()">取消</button>
        </div>

        <!-- 历史版本面板 -->
        <div class="history-panel" id="historyPanel">
            <h4>历史版本</h4>
            <ul id="historyList"></ul>
        </div>
    </div>

    <script>
        // 初始化配置
        const EMOJI_MAP = {
            smileys: ['😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣', '😊', '😇'],
            symbols: ['⭐', '✨', '❄️', '❤️', '💡', '🎉', '✅', '❌', '⚠️', '⚡']
        };

        // 增强的Markdown解析
        const renderer = {
            code(code, lang) {
                if (lang === 'mermaid') {
                    return `<div class="mermaid">${code}</div>`;
                }
                return `<pre><code class="hljs ${lang}">${hljs.highlightAuto(code).value}</code></pre>`;
            },
            image(href, title, text) {
                return `<img src="${href}" alt="${text}" class="md-image">`;
            }
        };

        // 初始化编辑器
        function initEditor() {
            // 初始化事件监听
            editor.addEventListener('input', debounce(updatePreview, 300));
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
            
            // 加载历史版本
            loadHistory();
        }

        // 完整表情功能
        function showEmojiPicker(e) {
            const picker = document.getElementById('emojiPicker');
            picker.style.display = 'block';
            picker.style.left = `${e.clientX}px`;
            picker.style.top = `${e.clientY}px`;
            if (!picker.innerHTML) renderEmojis();
        }

        function renderEmojis() {
            Object.entries(EMOJI_MAP).forEach(([category, items]) => {
                const container = document.getElementById(category);
                container.innerHTML = items.map(emoji => `
                    <span class="emoji-item" onclick="insertEmoji('${emoji}')">${emoji}</span>
                `).join('');
            });
        }

        // 完整表格生成
        function generateTable() {
            const rows = parseInt(document.getElementById('rows').value);
            const cols = parseInt(document.getElementById('cols').value);
            const hasHeader = document.getElementById('hasHeader').checked;
            const align = document.getElementById('alignment').value;
            
            let tableMd = '';
            if (hasHeader) {
                tableMd += '| ' + ' Header |'.repeat(cols) + '\n';
                tableMd += '|' + ` ${getAlignmentMark(align)} |`.repeat(cols) + '\n';
            }
            for (let i=0; i<rows; i++) {
                tableMd += '| ' + ' Content |'.repeat(cols) + '\n';
            }
            insertText(tableMd);
        }

        // 数学公式支持
        function insertFormula(type) {
            const template = type === 'block' ? '\n$$\n\\boxed{E=mc^2}\n$$\n' : ' $E=mc^2$ ';
            insertText(template);
        }

        // 增强代码插入
        function insertCodeBlock(lang) {
            const template = 
                '```' + lang + '\n' +
                (lang === 'mermaid' ? 
                    'graph TD\n  A[开始] --> B(结束)' : 
                    '// 输入代码...') + 
                '\n```';
            insertText(template);
        }

        // 历史版本管理
        let history = JSON.parse(localStorage.getItem('editHistory') || '[]');
        
        function saveHistory() {
            history.push({
                content: editor.value,
                timestamp: new Date().toLocaleString()
            });
            if (history.length > 5) history.shift();
            localStorage.setItem('editHistory', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            document.getElementById('historyList').innerHTML = history
                .map((item, index) => `
                    <li>
                        <span>版本${index+1}</span>
                        <small>${item.timestamp}</small>
                        <button onclick="loadVersion(${index})">恢复</button>
                    </li>
                `).join('');
        }

        // 初始化所有组件
        window.onload = function() {
            initEditor();
            mermaid.initialize({ theme: 'neutral' });
            hljs.initHighlightingOnLoad();
            renderEmojis();
        };
    </script>
</body>
</html>
