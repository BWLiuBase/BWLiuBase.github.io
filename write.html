<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å…¨åŠŸèƒ½åˆ›ä½œä¸­å¿ƒ - bwliubase</title>
    <!-- æ ¸å¿ƒä¾èµ– -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
    <style>
        /* åŸºç¡€æ ·å¼...ï¼ˆä¿ç•™åŸæœ‰åŸºç¡€æ ·å¼ï¼‰ */

        /* å¢å¼ºå·¥å…·æ  */
        .toolbar-group {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 5px 0;
            border-right: 1px solid var(--border-color);
            padding-right: 15px;
        }

        /* ä»£ç è¯­è¨€é€‰æ‹©å™¨ */
        .lang-selector {
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            margin-left: 10px;
        }

        /* è¡¨æ ¼ç¼–è¾‘å™¨ */
        .table-config {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 10px 0;
        }

        /* è¡¨æƒ…é¢æ¿å¢å¼º */
        .emoji-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }

        .emoji-tab {
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
        }

        .emoji-tab.active {
            background: var(--primary-color);
            color: white;
        }

        /* å…¬å¼å·¥å…·æ  */
        .formula-toolbar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }

        /* å†å²ç‰ˆæœ¬é¢æ¿ */
        .history-panel {
            position: fixed;
            right: 20px;
            top: 100px;
            width: 300px;
            background: white;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <!-- ç¼–è¾‘å™¨å·¦ä¾§ -->
        <div class="editor-pane">
            <div class="editor-toolbar">
                <!-- åŠŸèƒ½åˆ†ç»„ -->
                <div class="toolbar-group">
                    <button onclick="formatText('bold')"><strong>B</strong></button>
                    <button onclick="formatText('italic')"><em>I</em></button>
                    <button onclick="showEmojiPicker(event)">ğŸ˜€</button>
                    <select class="lang-selector" onchange="insertCodeBlock(this.value)">
                        <option value="">ä»£ç è¯­è¨€</option>
                        <option value="javascript">JavaScript</option>
                        <option value="python">Python</option>
                        <option value="java">Java</option>
                        <option value="mermaid">Mermaid</option>
                    </select>
                </div>
                
                <div class="toolbar-group">
                    <button onclick="showTableDialog()">è¡¨æ ¼</button>
                    <button onclick="insertFormula('block')">å…¬å¼å—</button>
                    <button onclick="insertFormula('inline')">è¡Œå†…å…¬å¼</button>
                    <input type="file" id="imageUpload" hidden multiple>
                </div>
            </div>
            <textarea id="editor"></textarea>
        </div>

        <!-- é¢„è§ˆåŒºåŸŸ -->
        <div class="preview-pane" id="preview"></div>

        <!-- è¡¨æƒ…é€‰æ‹©å™¨ -->
        <div id="emojiPicker" class="emoji-picker">
            <div class="emoji-tabs">
                <div class="emoji-tab active" onclick="switchEmojiTab('smileys')">è¡¨æƒ…</div>
                <div class="emoji-tab" onclick="switchEmojiTab('symbols')">ç¬¦å·</div>
            </div>
            <div class="emoji-category" id="smileys">
                <!-- åŠ¨æ€åŠ è½½è¡¨æƒ… -->
            </div>
            <div class="emoji-category" id="symbols" style="display:none;">
                <!-- ç‰¹æ®Šç¬¦å· -->
            </div>
        </div>

        <!-- è¡¨æ ¼é…ç½®å¯¹è¯æ¡† -->
        <div class="table-dialog" id="tableDialog">
            <h3>åˆ›å»ºè¡¨æ ¼</h3>
            <div class="table-config">
                <label>è¡Œæ•° <input type="number" id="rows" min="1" value="3"></label>
                <label>åˆ—æ•° <input type="number" id="cols" min="1" value="3"></label>
                <label>è¡¨å¤´ <input type="checkbox" id="hasHeader" checked></label>
                <select id="alignment">
                    <option value="left">å·¦å¯¹é½</option>
                    <option value="center">å±…ä¸­</option>
                    <option value="right">å³å¯¹é½</option>
                </select>
            </div>
            <button onclick="generateTable()">ç”Ÿæˆ</button>
            <button onclick="closeDialog()">å–æ¶ˆ</button>
        </div>

        <!-- å†å²ç‰ˆæœ¬é¢æ¿ -->
        <div class="history-panel" id="historyPanel">
            <h4>å†å²ç‰ˆæœ¬</h4>
            <ul id="historyList"></ul>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–é…ç½®
        const EMOJI_MAP = {
            smileys: ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡'],
            symbols: ['â­', 'âœ¨', 'â„ï¸', 'â¤ï¸', 'ğŸ’¡', 'ğŸ‰', 'âœ…', 'âŒ', 'âš ï¸', 'âš¡']
        };

        // å¢å¼ºçš„Markdownè§£æ
        const renderer = {
            code(code, lang) {
                if (lang === 'mermaid') {
                    return `<div class="mermaid">${code}</div>`;
                }
                return `<pre><code class="hljs ${lang}">${hljs.highlightAuto(code).value}</code></pre>`;
            },
            image(href, title, text) {
                return `<img src="${href}" alt="${text}" class="md-image">`;
            }
        };

        // åˆå§‹åŒ–ç¼–è¾‘å™¨
        function initEditor() {
            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
            editor.addEventListener('input', debounce(updatePreview, 300));
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
            
            // åŠ è½½å†å²ç‰ˆæœ¬
            loadHistory();
        }

        // å®Œæ•´è¡¨æƒ…åŠŸèƒ½
        function showEmojiPicker(e) {
            const picker = document.getElementById('emojiPicker');
            picker.style.display = 'block';
            picker.style.left = `${e.clientX}px`;
            picker.style.top = `${e.clientY}px`;
            if (!picker.innerHTML) renderEmojis();
        }

        function renderEmojis() {
            Object.entries(EMOJI_MAP).forEach(([category, items]) => {
                const container = document.getElementById(category);
                container.innerHTML = items.map(emoji => `
                    <span class="emoji-item" onclick="insertEmoji('${emoji}')">${emoji}</span>
                `).join('');
            });
        }

        // å®Œæ•´è¡¨æ ¼ç”Ÿæˆ
        function generateTable() {
            const rows = parseInt(document.getElementById('rows').value);
            const cols = parseInt(document.getElementById('cols').value);
            const hasHeader = document.getElementById('hasHeader').checked;
            const align = document.getElementById('alignment').value;
            
            let tableMd = '';
            if (hasHeader) {
                tableMd += '| ' + ' Header |'.repeat(cols) + '\n';
                tableMd += '|' + ` ${getAlignmentMark(align)} |`.repeat(cols) + '\n';
            }
            for (let i=0; i<rows; i++) {
                tableMd += '| ' + ' Content |'.repeat(cols) + '\n';
            }
            insertText(tableMd);
        }

        // æ•°å­¦å…¬å¼æ”¯æŒ
        function insertFormula(type) {
            const template = type === 'block' ? '\n$$\n\\boxed{E=mc^2}\n$$\n' : ' $E=mc^2$ ';
            insertText(template);
        }

        // å¢å¼ºä»£ç æ’å…¥
        function insertCodeBlock(lang) {
            const template = 
                '```' + lang + '\n' +
                (lang === 'mermaid' ? 
                    'graph TD\n  A[å¼€å§‹] --> B(ç»“æŸ)' : 
                    '// è¾“å…¥ä»£ç ...') + 
                '\n```';
            insertText(template);
        }

        // å†å²ç‰ˆæœ¬ç®¡ç†
        let history = JSON.parse(localStorage.getItem('editHistory') || '[]');
        
        function saveHistory() {
            history.push({
                content: editor.value,
                timestamp: new Date().toLocaleString()
            });
            if (history.length > 5) history.shift();
            localStorage.setItem('editHistory', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            document.getElementById('historyList').innerHTML = history
                .map((item, index) => `
                    <li>
                        <span>ç‰ˆæœ¬${index+1}</span>
                        <small>${item.timestamp}</small>
                        <button onclick="loadVersion(${index})">æ¢å¤</button>
                    </li>
                `).join('');
        }

        // åˆå§‹åŒ–æ‰€æœ‰ç»„ä»¶
        window.onload = function() {
            initEditor();
            mermaid.initialize({ theme: 'neutral' });
            hljs.initHighlightingOnLoad();
            renderEmojis();
        };
    </script>
</body>
</html>
